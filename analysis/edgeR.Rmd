---
title: "portsmouth-darek-mdxbrain"
output:
  html_document:
    toc: yes
    df_print: paged

date: "_Last draft: `r format(Sys.time(), '%d %B, %Y %H:%M:%S')`_"
description: "mdx mice analysis"

knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_file = paste0(
        xfun::sans_ext(input), '-', format(Sys.time(), "%Y-%m-%d_%H-%M"), '.html'
      ),
      knit_root_dir = xfun::proj_root(),
      envir = globalenv()
    )
  })
---


```{r install_libraries, eval=FALSE, include=FALSE}
library(devtools)
devtools::install_github("zhangyuqing/sva-devel")
devtools::install_github("yanlinlin82/ggvenn")
deftools::install_github("jokergoo/ComplexHeatmap")
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
# https://github.com/Bioconductor/bioconductor_docker/issues/22
BiocManager::install("preprocessCore", configure.args="--disable-threading")
```

```{r load_libraries, include=FALSE}
library(IRanges)
library(sets)
library(preprocessCore)
library(RColorBrewer)
library(ComplexHeatmap)
library(circlize)
library(tidyverse)

source('analysis/utils.R')
library(edgeR)
library(ggvenn)
```

```{r}
expression_dist_matrix <- function(counts_df) {
  counts_df %>%
  select(starts_with('sample_')) %>%
  as.matrix() %>%
  # library(Rfast2)
  # t() %>%
  # dcora()  # correlation as distance
  dist(method = 'canberra') %>%
  as.matrix()
}

overlap_ratio_matrix <- function(counts_df){
  query <- IRanges(
    counts_df$start,
    counts_df$end
  )
  
  overlap_pairs <-
    findOverlaps(query) %>%
    as.data.frame() %>%
    mutate(
      query_start = counts_df$start[queryHits],
      query_end = counts_df$end[queryHits],
      subject_start = counts_df$start[subjectHits],
      subject_end = counts_df$end[subjectHits],
      query_gene_name = counts_df$gene_name[queryHits],
      subject_gene_name = counts_df$gene_name[subjectHits],
      query_chr = counts_df$chr[queryHits],
      subject_chr = counts_df$chr[subjectHits],
    ) %>%
    mutate(
      overlap_width = pmin(query_end, subject_end)
      - pmax(query_start, subject_start),
      shorter_range = pmin(query_end - query_start, subject_end - subject_start),
      longer_range = pmax(query_end - query_start, subject_end - subject_start),
    ) %>%
    mutate(
      # ratio = overlap_width / longer_range
      ratio = if_else(query_chr == subject_chr, overlap_width / shorter_range, 0)
    )
    
  overlap_matrix <- matrix(0, nrow = nrow(dist_matrix), ncol = ncol(dist_matrix))
  for (i in 1:nrow(overlap_pairs)) {
    query <- overlap_pairs[i, 'queryHits']
    subject <- overlap_pairs[i, 'subjectHits']
    ratio <- overlap_pairs[i, 'ratio']
  
    overlap_matrix[query, subject] <- ratio
  }
  overlap_matrix
}


reduce_sets <- function(gene_sets) {
  out <- list(gene_sets[[1]])
  for (x in gene_sets) {
    create_new <- TRUE
    for (iy in 1:length(out)) {
      y <- out[[iy]]
      if (!set_is_empty(set_intersection(x, y))) {
        out[[iy]] <- sort(unique(c(out[[iy]], x)))
        create_new <- FALSE
      }
    }
    if (create_new)
      out[[length(out) + 1]] <- x
  }
  out
}

gene_sets <- function(m) {
  gene_sets <- apply(unname(m), 1, which)
  new_gene_sets <- list()
  for (x in gene_sets) {
    x <- unname(x)
    if (length(x) > 2) {
      new_gene_sets[[length(new_gene_sets) + 1]] <- x
    }
  }
  
  if (length(new_gene_sets) == 0) {
    return()
  }
  
  old_gene_sets <- list()
  while(!identical(old_gene_sets, new_gene_sets)) {
    old_gene_sets <- new_gene_sets
    new_gene_sets <- reduce_sets(old_gene_sets)
  }
  new_gene_sets
}

find_go_genes <- function(go_ids, go_db) {
  genes <- list()
  for (go_id in go_ids) {
    go <- str_subset(go_db, go_id)
    stopifnot(length(go) == 1)
    go_genes <- str_split(go, '\t', simplify = TRUE)[1, -2]  # 1 is a name, 2 is empty
    genes[[go_genes[1]]] <- na.omit(go_genes[-1])
  }
  genes
}
```

```{r read_data}
go_biological_process_2021 <- read_lines(
  'data/GO_Biological_Process_2021.txt',
)

sample_info_rds_path <- 'data/sample_info.RDS'
sample_info <- readRDS(sample_info_rds_path)

counts_cerebrum_raw <-
  read_tsv('raw/cerebrum_gene-level-counts-annotated.tsv') %>%
  rename(
    gene_stable_id = `Gene stable ID`,
    gene_description = `Gene description`,
    chr = `Chromosome/scaffold name`,
    gene_name = `Gene name`,
    gene_type = `Gene type`,
    gene_synonym = `Gene Synonym`
  )
counts_cerebellum_raw <-
  read_tsv('raw/cerebellum_gene-level-counts-annotated.tsv') %>%
  rename(
    gene_stable_id = `Gene stable ID`,
    gene_description = `Gene description`,
    chr = `Chromosome/scaffold name`,
    gene_name = `Gene name`,
    gene_type = `Gene type`,
    gene_synonym = `Gene Synonym`
  )
counts_raw <-
  full_join(
    read_tsv('raw/cerebrum_gene-level-counts-annotated.tsv'),
    read_tsv('raw/cerebellum_gene-level-counts-annotated.tsv'),
    by = c(
      'Gene stable ID', 'Transcript stable ID', 'Exon stable ID',
      'Gene description', 'Chromosome/scaffold name', 'Gene start (bp)',
      'Gene end (bp)', 'Gene name', 'Gene type', 'Gene Synonym'
    )
  ) %>%
  rename(
    gene_stable_id = `Gene stable ID`,
    gene_description = `Gene description`,
    chr = `Chromosome/scaffold name`,
    gene_name = `Gene name`,
    gene_type = `Gene type`,
    gene_synonym = `Gene Synonym`
  )
```

```{r remove_duplicated_genes}
duplicated_genes <- c()

chr_subset <- c('1', '2', '3', '4', '5', '6', '7', '8')
counts_chr <-
  counts_raw %>%
  filter(gene_type == 'protein_coding') %>%
  rename(start=`Gene start (bp)`, end=`Gene end (bp)`) %>%
  select(gene_stable_id, gene_name, chr, start, end, starts_with('sample_')) %>%
  mutate(g = chr %in% chr_subset)
  # mutate(dup = duplicated(gene_name))

dist_matrix <- expression_dist_matrix(filter(counts_chr, g))
overlap_matrix <- overlap_ratio_matrix(filter(counts_chr, g))
result <- (overlap_matrix > 0.5) & (dist_matrix < 1.0)

for (s in gene_sets(result)) {
  print(s)
  genes <- 
    counts_chr %>%
    filter(g) %>%
    slice(s) %>%
    mutate(sum = apply(select(., starts_with('sample_')), 1, sum)) %>%
    arrange(-sum) %>%
    slice(-1) %>%
    pull(gene_stable_id)
  
  
    counts_chr %>%
    filter(g) %>%
    slice(s) %>%print
  
  duplicated_genes <- c(duplicated_genes, genes)
}

dist_matrix <- expression_dist_matrix(filter(counts_chr, !g))
overlap_matrix <- overlap_ratio_matrix(filter(counts_chr, !g))
result <- (overlap_matrix > 0.5) & (dist_matrix < 1)

for (s in gene_sets(result)) {
  print(s)
  genes <- 
    counts_chr %>%
    filter(!g) %>%
    slice(s) %>%
    mutate(sum = apply(select(., starts_with('sample_')), 1, sum)) %>%
    arrange(-sum) %>%
    slice(-1) %>%
    pull(gene_stable_id)

    counts_chr %>%
    filter(!g) %>%
    slice(s) %>%print
  
  duplicated_genes <- c(duplicated_genes, genes)
}

counts_cerebrum_raw <-
  filter(counts_cerebrum_raw, !gene_stable_id %in% duplicated_genes)
counts_cerebellum_raw <-
  filter(counts_cerebellum_raw, !gene_stable_id %in% duplicated_genes)
counts_raw <-
  filter(counts_raw, !gene_stable_id %in% duplicated_genes)
```

```{r prepare_data}
counts_cerebrum_normalized_log <-
  counts_cerebrum_raw %>%
  select(starts_with('sample_')) %>%
  as.matrix() %>%
  normalize.quantiles(keep.names = TRUE) %>%
  {{ log2(. + 1) }}
counts_cerebellum_normalized_log <-
  counts_cerebellum_raw %>%
  select(starts_with('sample_')) %>%
  as.matrix() %>%
  normalize.quantiles(keep.names = TRUE) %>%
  {{ log2(. + 1) }}
counts_normalized_log <-
  counts_raw %>%
  select(starts_with('sample_')) %>%
  as.matrix() %>%
  normalize.quantiles(keep.names = TRUE) %>%
  {{ log2(. + 1) }}

counts <-
  counts_raw %>%
  select(
    gene_stable_id, gene_description, chr, gene_name, gene_type, gene_synonym
  ) %>%
  bind_cols(counts_normalized_log)
counts_cerebrum <-
  counts_raw %>%
  select(
    gene_stable_id, gene_description, chr, gene_name, gene_type, gene_synonym
  ) %>%
  bind_cols(counts_cerebrum_normalized_log)
counts_cerebellum <-
  counts_raw %>%
  select(
    gene_stable_id, gene_description, chr, gene_name, gene_type, gene_synonym
  ) %>%
  bind_cols(counts_cerebellum_normalized_log)
```

```{r}
plot_info <-
  sample_info %>%
  arrange(desc(tissue), age_days, desc(genotype)) %>%
  mutate(
    `wt / mdx` = if_else(genotype == 'wt', 'yellow', 'black'),
    `10 days / 70 days` = if_else(age_days == 10, 'green', 'magenta'),
    `cerebrum / cerebellum` = if_else(tissue == 'cerebrum', 'red', 'blue'),
  )
```

```{r fit_model}
edger_model <- function(x, sample_info_groups, tissue=NA, contrast='genotype'){
  mdx_groups. <-
    sample_info_groups %>%
    `[`(match(colnames(x), .$id), ) %>%
    pull(group) %>%
    factor()

  dge_counts <- DGEList(counts = x, group = mdx_groups.)
  keep_counts <- filterByExpr(dge_counts)
  dge_counts <- dge_counts[keep_counts, , keep.lib.sizes = FALSE]

  dge_counts <- calcNormFactors(dge_counts)
  design <- model.matrix(~ 0 + mdx_groups.)
  dge_counts <- estimateDisp(dge_counts, design)

  fit <- glmQLFit(dge_counts, design)

  # contrasts
  if (tissue %in% c('cerebrum', 'cerebellum')){
    contrasts <- makeContrasts(
      # overall genotype effect
      genotype=(
        (mdx_groups.wt_10 + mdx_groups.wt_70)
        - (mdx_groups.mdx_10 + mdx_groups.mdx_70)
      ),
      genotype_10=mdx_groups.wt_10 - mdx_groups.mdx_10,
      genotype_70=mdx_groups.wt_70 - mdx_groups.mdx_70,
      age_days=(
        (mdx_groups.wt_10 + mdx_groups.mdx_10)
        - (mdx_groups.wt_70 + mdx_groups.mdx_70)
      ),
      interaction=(
        (mdx_groups.wt_10 - mdx_groups.mdx_10)
        - (mdx_groups.wt_70 - mdx_groups.mdx_70)
      ),
      levels = design
    )
  } else {
    contrasts <- makeContrasts(
      # overall genotype effect
      genotype=
        (
          mdx_groups.wt_10_cerebrum + mdx_groups.wt_70_cerebrum
          + mdx_groups.wt_10_cerebellum + mdx_groups.wt_70_cerebellum
        )
        - (
          mdx_groups.mdx_10_cerebrum + mdx_groups.mdx_70_cerebrum
          + mdx_groups.mdx_10_cerebellum + mdx_groups.mdx_70_cerebellum
        ),
      levels = design
    )
  }
  results <- glmQLFTest(fit, contrast=contrasts[, contrast])

  topTags(results, n = 'inf')$table %>%
    as_tibble(rownames = 'row_index')
}
```


```{r edger_statistic}
.cerebrum_edger <- function(contrast) {
  edger_model(
    select(counts_cerebrum_raw, starts_with('sample_')),
    sample_info %>%
      filter(tissue == 'cerebrum') %>%
      mutate(group = paste(genotype, age_days, sep = '_')),
    tissue = 'cerebrum',
    contrast = contrast
  )
}

edger_genes_cerebrum <-
  .cerebrum_edger(
    contrast = 'genotype'
  ) %>%
  rename_with(.fn = ~ paste0(.x, '.genotype'), .cols = -row_index) %>%
  full_join(
    rename_with(
      .cerebrum_edger(contrast = 'genotype_10'),
      .fn = ~ paste0(.x, '.genotype_10'),
      .cols = -row_index
    )
  ) %>%
  full_join(
    rename_with(
      .cerebrum_edger(contrast = 'genotype_70'),
      .fn = ~ paste0(.x, '.genotype_70'),
      .cols = -row_index
    )
  ) %>%
  full_join(
    rename_with(
      .cerebrum_edger(contrast = 'age_days'),
      .fn = ~ paste0(.x, '.age_days'),
      .cols = -row_index
    )
  ) %>%
  full_join(
    rename_with(
      .cerebrum_edger(contrast = 'interaction'),
      .fn = ~ paste0(.x, '.interaction'),
      .cols = -row_index
    )
  ) %>%
  mutate(
    gene_name = counts_cerebrum_raw[as.numeric(.$row_index), ]$gene_name,
    gene_stable_id = counts_cerebrum_raw[as.numeric(.$row_index), ]$gene_stable_id,
    gene_type = counts_cerebrum_raw[as.numeric(.$row_index), ]$gene_type,
    .before = everything()
  ) %>%
  filter(gene_type == 'protein_coding') %>%
  select(-row_index, -gene_type)

.cerebellum_edger <- function(contrast) {
  edger_model(
    select(counts_cerebellum_raw, starts_with('sample_')),
    sample_info %>%
      filter(tissue == 'cerebellum') %>%
      mutate(group = paste(genotype, age_days, sep = '_')),
    tissue = 'cerebellum',
    contrast = contrast
  )
}
edger_genes_cerebellum <-
  .cerebellum_edger(
    contrast = 'genotype'
  ) %>%
  rename_with(.fn = ~ paste0(.x, '.genotype'), .cols = -row_index) %>%
  full_join(
    rename_with(
      .cerebellum_edger(contrast = 'genotype_10'),
      .fn = ~ paste0(.x, '.genotype_10'),
      .cols = -row_index
    )
  ) %>%
  full_join(
    rename_with(
      .cerebellum_edger(contrast = 'genotype_70'),
      .fn = ~ paste0(.x, '.genotype_70'),
      .cols = -row_index
    )
  ) %>%
  full_join(
    rename_with(
      .cerebellum_edger(contrast = 'age_days'),
      .fn = ~ paste0(.x, '.age_days'),
      .cols = -row_index
    )
  ) %>%
  full_join(
    rename_with(
      .cerebellum_edger(contrast = 'interaction'),
      .fn = ~ paste0(.x, '.interaction'),
      .cols = -row_index
    )
  ) %>%
  mutate(
    gene_name = counts_cerebellum_raw[as.numeric(.$row_index), ]$gene_name,
    gene_stable_id = counts_cerebellum_raw[as.numeric(.$row_index), ]$gene_stable_id,
    gene_type = counts_cerebellum_raw[as.numeric(.$row_index), ]$gene_type,
    .before = everything()
  ) %>%
  filter(gene_type == 'protein_coding') %>%
  select(-row_index, -gene_type)

edger_genes_tissues <-
  full_join(
    edger_genes_cerebrum,
    edger_genes_cerebellum,
    suffix = c('.cerebrum', '.cerebellum'),
    by = c('gene_name', 'gene_stable_id')
  )
```


# All tissues

```{r}
x <- select(counts_raw, matches('sample_'))
sample_info_groups <-
  sample_info %>%
    mutate(group = paste(genotype, age_days, tissue, sep = '_'))

edger_genes <-
  edger_model(x, sample_info_groups) %>%
  mutate(
    gene_name = counts_raw[as.numeric(.$row_index), ]$gene_name,
    gene_stable_id = counts_raw[as.numeric(.$row_index), ]$gene_stable_id,
    .before = everything()
  ) %>%
  select(-row_index)
```

```{r draw_heatmap_03, echo=FALSE, fig.align="center", fig.height=15, fig.width=10, results='asis', include=TRUE, warning=FALSE}
plot_data <-
  counts %>%
  full_join(edger_genes, by = c('gene_stable_id', 'gene_name')) %>%
  filter(FDR < 0.001)

.x <- plot_data %>% select(all_of(plot_info$id)) %>% as.matrix()
rownames(.x) <- plot_data$gene_name
.rdbu_ramp <- colorRampPalette(brewer.pal(11, "RdBu"))
.col_side_colors <- plot_info %>% select(contains('/')) %>% as.matrix()
.way = 'genotype / genotype:tissue / genotype:age_days / genotype:tissue:age_days'

h <- heatmap.3(
    x = .x,
    main = 'edgeR',
    Rowv = TRUE,
    Colv = FALSE,
    dendrogram = 'row',
    distfun = function(x) as.dist(1-cor(t(x))),
    scale = "row",
    breaks = seq(-2.5, 2.5, length.out = 25),
    col = rev(.rdbu_ramp(24)),
    trace = "none",
    ColSideColors = .col_side_colors,
    ColSideColorsSize = 6,
    key = FALSE,
    lhei = c(1.5, 20),
    lwid = c(1,5),
    cexRow = 1.2,
    cexCol = 1.5,
    margins = c(9, 8),
)
```

```{r}
ct <- cutree(as.hclust(h$rowDendrogram), k = 4)
ct_heatmap_order <- ct[rev(h$rowInd)]

clusters <- tibble(gene_name = names(ct_heatmap_order), cluster = ct_heatmap_order)

clusters %>%
  filter(cluster != 0) %>%
  pull(gene_name) %>%
  paste(collapse = '\n') %>%
  cat
```


# Cerebrum

```{r edger_cerebrum}
tiss = 'cerebrum'

plot_info_cerebrum <-
  plot_info %>%
  filter(tissue == tiss) %>%
  mutate(
    `cerebrum /` = `cerebrum / cerebellum`,
    .before = `cerebrum / cerebellum`,
    .keep = 'unused'
  )
```

```{r}
edger_genes_cerebrum %>%
  select(-starts_with('F.'), -starts_with('PValue.'), -starts_with('logCPM.')) %>%
  mutate(
    `age regulation` = if_else(logFC.age_days < 0, 'up', 'down'),
    `genotype regulation` = if_else(logFC.genotype < 0, 'up', 'down'),
    `genotype 10 days regulation` = if_else(logFC.genotype_10 < 0, 'up', 'down'),
    `genotype 10 weeks regulation` = if_else(logFC.genotype_70 < 0, 'up', 'down'),
  ) %>%
  mutate(
    across(starts_with('logFC'), .fns = function(x) { x * -1 }),
  ) %>%
  rename(
    `fold genotype` = logFC.genotype,
    `genotype FDR` = FDR.genotype,
    `fold genotype 10 days` = logFC.genotype_10,
    `genotype 10 days FDR` = FDR.genotype_10,
    `fold genotype 10 weeks` = logFC.genotype_70,
    `genotype 10 weeks FDR` = FDR.genotype_70,
    `fold age` = logFC.age_days,
    `age FDR` = FDR.age_days,
    `interaction FDR` = FDR.interaction
  ) %>%
  select(
    gene_name, gene_stable_id,
    matches('genotype($| FDR| regulation)'),
    matches('genotype 10 days'),
    matches('genotype 10 weeks'),
    matches('age'),
    matches('^interaction FDR$'),
  ) %>%
  write_csv('results/complex-heatmap/edger-cerebrum.csv')
```

```{r draw_heatmap_03, echo=FALSE, fig.align="center", fig.height=20, fig.width=12, results='asis', include=TRUE, warning=FALSE}
fdr_th <- 0.05
top_n_genes <- 10L
go_genes <- find_go_genes(
  c(
    'GO:0007268', 'GO:0016052',  # https://maayanlab.cloud/Enrichr/enrich?dataset=50e71ca36d7625f53d07be601ea0169a
    'GO:0006397', 'GO:0000398',  # https://maayanlab.cloud/Enrichr/enrich?dataset=dfe0a9232ad83c9744642dd342f14e44
    'GO:0048699', 'GO:0007409',  # https://maayanlab.cloud/Enrichr/enrich?dataset=2ad79e0f126153f1168f618974f90a59
    'GO:0006614', 'GO:0045047'  # https://maayanlab.cloud/Enrichr/enrich?dataset=efe1a8dd2c78b99d26e041c785ba8977
  ),
  go_db = go_biological_process_2021
)

plot_data <-
  counts_cerebrum %>%
  full_join(edger_genes_cerebrum, by = c('gene_stable_id', 'gene_name')) %>%
  filter(FDR.genotype < fdr_th) %>%
  filter(pmax(abs(logFC.genotype_10), abs(logFC.genotype_70)) >= 1.3) %>%
  filter(gene_stable_id != 'ENSMUSG00000064351') %>%  # after  quantile normalization it's top in all samples (all values are the same)
  mutate(
    cv_BD = apply(select(., starts_with('sample_BD')), 1, function(x) {sd(x) / mean(x)}),
    cv_BW = apply(select(., starts_with('sample_BW')), 1, function(x) {sd(x) / mean(x)}),
    cv_MD = apply(select(., starts_with('sample_MD')), 1, function(x) {sd(x) / mean(x)}),
    cv_MW = apply(select(., starts_with('sample_MW')), 1, function(x) {sd(x) / mean(x)}),
    max_cv = pmax(cv_BD, cv_BW, cv_MD, cv_MW)
  ) %>%
  filter((max_cv < 0.2)) %>%
  arrange(FDR.genotype)

anno_data_right <-
  plot_data %>%
  transmute(
    gene_name = gene_name,
    `genotype 10 days` = if_else(FDR.genotype_10 < fdr_th, 'sig', 'ns'),
    `genotype 10 weeks` = if_else(FDR.genotype_70 < fdr_th, 'sig', 'ns'),
  )
for (go_name in names(go_genes)) {
  anno_data_right <- mutate(
      anno_data_right,
      "{ go_name }" := if_else(toupper(gene_name) %in% go_genes[[go_name]], 'sig', 'ns')
    )
}
anno_data_right <- as.data.frame(anno_data_right)

.x <-
  plot_data %>%
  select(any_of(plot_info_cerebrum$id)) %>%
  as.matrix() %>%
  { t(scale(t(.))) }
.hc_cerebrum <-
  .x %>%
  (function(x) { 1 - cor(t(x)) }) %>%  # correlation as distance
  as.dist() %>%
  hclust()
plot_data_genes <-
  plot_data %>%
  mutate(ct = cutree(.hc_cerebrum, k = 4)) %>%
  group_by(ct) %>%
  mutate(n_na_gene_names = cumsum(is.na(gene_name))) %>%
  mutate(
    genotype_rank = if_else(
      is.na(gene_name), top_n_genes + 1L, min_rank(FDR.genotype) - n_na_gene_names
    )
  ) %>%
  ungroup() %>%
  mutate(at = row_number()) %>%
  filter(genotype_rank <= top_n_genes)
rownames(.x) <- plot_data$gene_name
colnames(.x) <-
  tibble(id = colnames(.x)) %>%
  left_join(sample_info, by = 'id') %>%
  mutate(age_days = if_else(age_days == 10, '10 days', '10 weeks')) %>%
  unite('col_names', genotype, age_days, sep = ' ') %>%
  pull(col_names)
.col_fun <- colorRamp2(
  seq(-2.5, 2.5, length.out = 24),
  rev(colorRampPalette(brewer.pal(11, "RdBu"))(24))
)
.right_annot_col <- list(
      'genotype 10 days' = c('sig'='#114355', 'ns'='white'),
      'genotype 10 weeks' = c('sig'='#665200', 'ns'='white')
)
for (go_name in names(go_genes)) {
  .right_annot_col[[go_name]] <- c('sig'='black', 'ns'='white')
}

path <- paste0('results/complex-heatmap/genotype-edger-', tiss, '-fold13-sd02.svg')
svg(path, width = 13, height = 7)
h_cerebrum <- Heatmap(
  .x,
  column_title = paste('genotype effect in', tiss, 'FDR <', format(fdr_th, scientific = FALSE)),
  cluster_columns = FALSE,
  cluster_rows = .hc_cerebrum,
  col = .col_fun,
  row_names_side = 'right',
  show_row_names = FALSE,
  row_dend_width = unit(3, 'cm'),
  row_split = 4,
  column_split = rep(1:4, each = 5),
  column_names_rot = 45,
  width = unit(350, 'points'),
  top_annotation = c(
    columnAnnotation(
      age = as.character(plot_info_cerebrum$age_days),
      genotype = as.character(plot_info_cerebrum$genotype),
      col = list(
        'age' = c('10' = '#FDBF6F', '70' = '#FF7F00'),
        'genotype' = c('wt' = '#CAB2D6', 'mdx' = '#6A3D9A')
      )
    )
  ),
  right_annotation = c(
    rowAnnotation(
      df = anno_data_right %>% select(starts_with('genotype')),
      gap = unit(5, 'points'),
      annotation_name_rot = 45,
      col = .right_annot_col
    ),
    rowAnnotation(
      df = anno_data_right %>% select(contains('GO:')),
      row_names = anno_mark(
        at = plot_data_genes$at,
        labels = plot_data_genes$gene_name,
      ),
      annotation_label = c(
        '', 'synaptic transmission', 'carbohydrate catabolism',
        'mRNA processing', 'mRNA splicing',
        'generation of neurons', 'axonogenesis',
        'membrane protein targeting', 'ER protein targeting'
      ),
      gap = unit(5, 'points'),
      annotation_name_rot = 45,
      col = .right_annot_col
    )
  ),
  use_raster = TRUE,
)
draw(h_cerebrum)
dev.off()

plot_data %>%
  select(gene_name, contains('logFC.genotype'), contains('FDR.genotyp')) %>%
  mutate(across(contains('logFC'), `-`)) %>%
  write_csv(paste0('results/complex-heatmap/', tiss, '-fold13-cv02.csv'))
```

```{r}
h_cerebrum <- draw(h_cerebrum)

ct <- 1
clusters_cerebrum <- tibble()
for (ct_heatmap_order in row_order(h_cerebrum)) {
  gene_names <-
    plot_data %>%
    slice(ct_heatmap_order) %>%
    pull(gene_name)
  clusters_cerebrum <- bind_rows(
    clusters_cerebrum,
    tibble(gene_name = gene_names, cluster = ct)
  )
  ct <- ct + 1
}

clusters_cerebrum %>%
  write_csv(paste0('results/complex-heatmap/edger-', tiss, '-clusters-', fdr_th, '.csv'))
```

```{r venn}
th <- 0.1

venn_plot_data <-
  edger_genes_cerebrum %>%
  mutate(
    age = FDR.age_days < th,
    genotype = FDR.genotype < th,
    age_regulation = if_else(logFC.age_days < 0, 'up', 'down'),
    genotype_regulation = if_else(logFC.genotype < 0, 'up', 'down'),
  )

.venn_age_name <- venn_plot_data %>%
  filter(age) %>%
  group_by(age_regulation) %>%
  summarise(n = n()) %>%
  arrange(desc(age_regulation)) %>%
  mutate(name = paste(age_regulation, n)) %>%
  pull(name) %>%
  paste0(collapse = ' / ') %>%
  { paste0('age (', paste0(., collapse = ' / '), ')') }
.venn_genotype_name <- venn_plot_data %>%
  filter(genotype) %>%
  group_by(genotype_regulation) %>%
  summarise(n = n()) %>%
  arrange(desc(genotype_regulation)) %>%
  mutate(name = paste(genotype_regulation, n)) %>%
  pull(name) %>%
  { paste0('genotype (', paste0(., collapse = ' / '), ')') }

ggplot() +
  geom_text(
    mapping = aes(x = 0, y = 1.8),
    label = tiss,
    size = 6
  ) +
  geom_venn(
    aes_string(A = 'age', B = 'genotype'),
    data = venn_plot_data,
    fill_color = c('#0073C2FF', '#EFC000FF'),
    set_names = c(.venn_age_name, .venn_genotype_name),
    set_name_size = 4,
    auto_scale = TRUE,
    show_percentage = FALSE,
    show_outside = 'none',
  ) +
  labs(
    caption = paste('Number of genes regulated by age or genotype in', tiss, '; FDR <', th)
  ) +
  coord_fixed() +
  theme_void()
ggsave(
  paste0('results/complex-heatmap/venn-', tiss, '-', th, '.svg'),
  bg = 'white',
  width = 9,
  height = 6
)
```

```{r venn_10_70}
th <- 0.1

venn_plot_data <-
  edger_genes_cerebrum %>%
  mutate(
    genotype_10 = FDR.genotype_10 < th,
    genotype_70 = FDR.genotype_70 < th,
    genotype_10_regulation = if_else(logFC.genotype_10 < 0, 'up', 'down'),
    genotype_70_regulation = if_else(logFC.genotype_70 < 0, 'up', 'down'),
  )

.venn_genotype_10_name <- venn_plot_data %>%
  filter(genotype_10) %>%
  group_by(genotype_10_regulation) %>%
  summarise(n = n()) %>%
  arrange(desc(genotype_10_regulation)) %>%
  mutate(name = paste(genotype_10_regulation, n)) %>%
  pull(name) %>%
  paste0(collapse = ' / ') %>%
  { paste0('genotype 10 days (', paste0(., collapse = ' / '), ')') }
.venn_genotype_70_name <- venn_plot_data %>%
  filter(genotype_70) %>%
  group_by(genotype_70_regulation) %>%
  summarise(n = n()) %>%
  arrange(desc(genotype_70_regulation)) %>%
  mutate(name = paste(genotype_70_regulation, n)) %>%
  pull(name) %>%
  { paste0('genotype 10 weeks (', paste0(., collapse = ' / '), ')') }

ggplot() +
  geom_text(
    mapping = aes(x = 0, y = 1.8),
    label = tiss,
    size = 6
  ) +
  geom_venn(
    aes_string(A = 'genotype_10', B = 'genotype_70'),
    data = venn_plot_data,
    fill_color = c('#0073C2FF', '#EFC000FF'),
    set_names = c(.venn_genotype_10_name, .venn_genotype_70_name),
    set_name_size = 3,
    auto_scale = TRUE,
    show_percentage = FALSE,
    show_outside = 'none',
  ) +
  labs(
    caption = paste('Number of genes regulated by genotype in 10 or 70 days old mice in', tiss, '; FDR <', th)
  ) +
  coord_fixed() +
  theme_void()
ggsave(
  paste0('results/complex-heatmap/venn-', tiss, '-in-age-', th, '.svg'),
  bg = 'white',
  width = 9,
  height = 6
)
```



# Cerebellum

```{r edger_cerebellum}
tiss = 'cerebellum'

plot_info_cerebellum <-
  plot_info %>%
  filter(tissue == tiss) %>%
  mutate(
    `/ cerebellum` = `cerebrum / cerebellum`,
    .before = `cerebrum / cerebellum`,
    .keep = 'unused'
  )
```

```{r}
edger_genes_cerebellum %>%
  select(-starts_with('F.'), -starts_with('PValue.'), -starts_with('logCPM.')) %>%
  mutate(
    `age regulation` = if_else(logFC.age_days < 0, 'up', 'down'),
    `genotype regulation` = if_else(logFC.genotype < 0, 'up', 'down'),
    `genotype 10 days regulation` = if_else(logFC.genotype_10 < 0, 'up', 'down'),
    `genotype 10 weeks regulation` = if_else(logFC.genotype_70 < 0, 'up', 'down'),
  ) %>%
  mutate(
    across(starts_with('logFC'), .fns = function(x) { x * -1 }),
  ) %>%
  rename(
    `fold genotype` = logFC.genotype,
    `genotype FDR` = FDR.genotype,
    `fold genotype 10 days` = logFC.genotype_10,
    `genotype 10 days FDR` = FDR.genotype_10,
    `fold genotype 10 weeks` = logFC.genotype_70,
    `genotype 10 weeks FDR` = FDR.genotype_70,
    `fold age` = logFC.age_days,
    `age FDR` = FDR.age_days,
    `interaction FDR` = FDR.interaction
  ) %>%
  select(
    gene_name, gene_stable_id,
    matches('genotype($| FDR| regulation)'),
    matches('genotype 10 days'),
    matches('genotype 10 weeks'),
    matches('age'),
    matches('^interaction FDR$'),
  ) %>%
  write_csv('results/complex-heatmap/edger-cerebellum.csv')
```


```{r draw_heatmap, echo=FALSE, fig.align="center", fig.width=10, fig.height=14, results='asis', include=TRUE, warning=FALSE}
fdr_th <- 0.05
go_genes <- find_go_genes(
  c(
    'GO:1900034',  # https://maayanlab.cloud/Enrichr/enrich?dataset=c775ed219cdea7ad23122f822d15924e
    'GO:0033146',  # https://maayanlab.cloud/Enrichr/enrich?dataset=744e4f18c6894a38767037523d521681
    'GO:0006936'  # https://maayanlab.cloud/Enrichr/enrich?dataset=9080d555d5451496d428446459a94a0a
    # 'GO:2000812', 'GO:0060441'  # https://maayanlab.cloud/Enrichr/enrich?dataset=dad307fc0684fb36a26f1acfd300c201
  ),
  go_db = go_biological_process_2021
)

plot_data <-
  counts_cerebellum %>%
  full_join(edger_genes_cerebellum, by = c('gene_stable_id', 'gene_name')) %>%
  filter(FDR.genotype < fdr_th, !is.na(gene_name)) %>%
  mutate(
    genotype_10 = if_else(FDR.genotype_10 < fdr_th, 'sig', 'ns'),
    genotype_70 = if_else(FDR.genotype_70 < fdr_th, 'sig', 'ns'),
  ) %>%
  mutate(
    cv_BD = apply(select(., sample_BD1:sample_BD5), 1, function(x) {sd(x) / mean(x)}),
    cv_BW = apply(select(., sample_BW1:sample_BW5), 1, function(x) {sd(x) / mean(x)}),
    cv_MD = apply(select(., sample_MD1:sample_MD5), 1, function(x) {sd(x) / mean(x)}),
    cv_MW = apply(select(., sample_MW1:sample_MW5), 1, function(x) {sd(x) / mean(x)}),
    max_cv = pmax(cv_BD, cv_BW, cv_MD, cv_MW),
  ) %>%
  filter((max_cv < 0.2)) %>%
  filter(pmax(abs(logFC.genotype_10), abs(logFC.genotype_70)) >= 1.3) %>%
  arrange(FDR.genotype)

anno_data_right <-
  plot_data %>%
  transmute(
    gene_name = gene_name,
    `genotype 10 days` = if_else(FDR.genotype_10 < fdr_th, 'sig', 'ns'),
    `genotype 10 weeks` = if_else(FDR.genotype_70 < fdr_th, 'sig', 'ns'),
  )
for (go_name in names(go_genes)) {
  anno_data_right <- mutate(
      anno_data_right,
      "{ go_name }" := if_else(toupper(gene_name) %in% go_genes[[go_name]], 'sig', 'ns')
    )
}
anno_data_right <- as.data.frame(anno_data_right)

.x <-
  plot_data %>%
  select(any_of(plot_info_cerebellum$id)) %>%
  as.matrix() %>%
  { t(scale(t(.))) }
rownames(.x) <- plot_data$gene_name
colnames(.x) <-
  tibble(id = colnames(.x)) %>%
  left_join(sample_info, by = 'id') %>%
  mutate(age_days = if_else(age_days == 10, '10 days', '10 weeks')) %>%
  unite('col_names', genotype, age_days, sep = ' ') %>%
  pull(col_names)
.col_fun <- colorRamp2(
  seq(-2.5, 2.5, length.out = 24),
  rev(colorRampPalette(brewer.pal(11, "RdBu"))(24))
)
.right_annot_col <- list(
      'genotype 10 days' = c('sig'='#15546a', 'ns'='white'),
      'genotype 10 weeks' = c('sig'='#806600', 'ns'='white')  # little lighter than cerebrum
)
for (go_name in names(go_genes)) {
  .right_annot_col[[go_name]] <- c('sig'='gray20', 'ns'='white')
}

path <- paste0('results/complex-heatmap/genotype-edger-', tiss, '-fold13-cv02.svg')
svg(path, width = 12, height = 6)
h_cerebellum <- Heatmap(
  .x,
  column_title = paste('genotype effect in', tiss, 'FDR <', format(fdr_th, scientific = FALSE)),
  cluster_columns = FALSE,
  clustering_distance_rows = function(x) as.dist(1-cor(t(x))),
  col = .col_fun,
  row_names_side = 'right',
  row_dend_width = unit(3, 'cm'),
  row_split = 4,
  column_names_rot = 45,
  column_split = rep(1:4, each = 5),
  top_annotation = c(
    columnAnnotation(
      age = as.character(plot_info_cerebellum$age_days),
      genotype = as.character(plot_info_cerebellum$genotype),
      col = list(
        'age' = c('10' = '#FDBF6F', '70' = '#FF7F00'),
        'genotype' = c('wt' = '#CAB2D6', 'mdx' = '#6A3D9A')
      )
    )
  ),
  right_annotation = c(
    rowAnnotation(
      df = select(anno_data_right, -gene_name),
      annotation_label = c(
        'genotype 10 days', 'genotype 10 weeks',
        'response to heat', 'estrogen receptor signaling', 'muscle contraction'
      ),
      gap = unit(5, 'points'),
      annotation_name_rot = 45,
      col = .right_annot_col
    )
  )
)
draw(h_cerebellum)
dev.off()

plot_data %>%
  select(gene_name, contains('logFC.genotype'), contains('FDR.genotyp')) %>%
  mutate(across(contains('logFC'), `-`)) %>%
  write_csv(paste0('results/complex-heatmap/', tiss, '-fold13-cv02.csv'))
```

```{r}
h_cerebellum <- draw(h_cerebellum)

ct <- 1
clusters_cerebellum <- tibble()
for (ct_heatmap_order in row_order(h_cerebellum)) {
  gene_names <-
    plot_data %>%
    slice(ct_heatmap_order) %>%
    pull(gene_name)
  clusters_cerebellum <- bind_rows(
    clusters_cerebellum,
    tibble(gene_name = gene_names, cluster = ct)
  )
  ct <- ct + 1
}

clusters_cerebellum %>%
  write_csv(paste0('results/complex-heatmap/edger-', tiss, '-clusters-', fdr_th, '.csv'))
```

```{r venn2}
th <- 0.1

venn_plot_data <-
  edger_genes_cerebellum %>%
  mutate(
    age = FDR.age_days < th,
    genotype = FDR.genotype < th,
    age_regulation = if_else(logFC.age_days < 0, 'up', 'down'),
    genotype_regulation = if_else(logFC.genotype < 0, 'up', 'down'),
  )

.venn_age_name <- venn_plot_data %>%
  filter(age) %>%
  group_by(age_regulation) %>%
  summarise(n = n()) %>%
  arrange(desc(age_regulation)) %>%
  mutate(name = paste(age_regulation, n)) %>%
  pull(name) %>%
  paste0(collapse = ' / ') %>%
  { paste0('age (', paste0(., collapse = ' / '), ')') }
.venn_genotype_name <- venn_plot_data %>%
  filter(genotype) %>%
  group_by(genotype_regulation) %>%
  summarise(n = n()) %>%
  arrange(desc(genotype_regulation)) %>%
  mutate(name = paste(genotype_regulation, n)) %>%
  pull(name) %>%
  { paste0('genotype (', paste0(., collapse = ' / '), ')') }

ggplot() +
  geom_text(
    mapping = aes(x = 0, y = 1.8),
    label = tiss,
    size = 6
  ) +
  geom_venn(
    aes_string(A = 'age', B = 'genotype'),
    data = venn_plot_data,
    fill_color = c('#984EA3FF', '#FF7F00FF'),
    set_names = c(.venn_age_name, .venn_genotype_name),
    set_name_size = 4,
    auto_scale = TRUE,
    show_percentage = FALSE,
    show_outside = 'none',
  ) +
  labs(
    caption = paste('Number of genes regulated by age or genotype in', tiss, '; FDR <', th)
  ) +
  coord_fixed() +
  theme_void()
ggsave(
  paste0('results/complex-heatmap/venn-', tiss, '-', th, '.svg'),
  bg = 'white',
  width = 9,
  height = 6
)
```

```{r venn_10_702}
th <- 0.1

venn_plot_data <-
  edger_genes_cerebellum %>%
  mutate(
    genotype_10 = FDR.genotype_10 < th,
    genotype_70 = FDR.genotype_70 < th,
    genotype_10_regulation = if_else(logFC.genotype_10 < 0, 'up', 'down'),
    genotype_70_regulation = if_else(logFC.genotype_70 < 0, 'up', 'down'),
  )

.venn_genotype_10_name <- venn_plot_data %>%
  filter(genotype_10) %>%
  group_by(genotype_10_regulation) %>%
  summarise(n = n()) %>%
  arrange(desc(genotype_10_regulation)) %>%
  mutate(name = paste(genotype_10_regulation, n)) %>%
  pull(name) %>%
  paste0(collapse = ' / ') %>%
  { paste0('genotype 10 days (', paste0(., collapse = ' / '), ')') }
.venn_genotype_70_name <- venn_plot_data %>%
  filter(genotype_70) %>%
  group_by(genotype_70_regulation) %>%
  summarise(n = n()) %>%
  arrange(desc(genotype_70_regulation)) %>%
  mutate(name = paste(genotype_70_regulation, n)) %>%
  pull(name) %>%
  { paste0('genotype 10 weeks (', paste0(., collapse = ' / '), ')') }

ggplot() +
  geom_text(
    mapping = aes(x = 0, y = 1.8),
    label = tiss,
    size = 6
  ) +
  geom_venn(
    aes_string(A = 'genotype_10', B = 'genotype_70'),
    data = venn_plot_data,
    fill_color = c('#984EA3FF', '#FF7F00FF'),
    set_names = c(.venn_genotype_10_name, .venn_genotype_70_name),
    set_name_size = 3,
    auto_scale = TRUE,
    show_percentage = FALSE,
    show_outside = 'none',
  ) +
  labs(
    caption = paste('Number of genes regulated by genotype in 10 or 70 days old mice in', tiss, '; FDR <', th)
  ) +
  coord_fixed() +
  theme_void()
ggsave(
  paste0('results/complex-heatmap/venn-', tiss, '-in-age-', th, '.svg'),
  bg = 'white',
  width = 9,
  height = 6
)
```



# Merge

```{r draw_heatmap_merged, echo=FALSE, fig.align="center", fig.width=7, fig.height=10, results='asis', include=TRUE, warning=FALSE}
fdr_th <- 0.1

plot_data <-
  edger_genes_tissues %>%
  filter(FDR.genotype.cerebrum < fdr_th, FDR.genotype.cerebellum < fdr_th) %>%
  select(
    gene_name, FDR.genotype.cerebrum, FDR.genotype.cerebellum,
    logFC.genotype.cerebrum, logFC.genotype.cerebellum,
  ) %>%
  mutate(
    logFC.genotype.cerebrum = case_when(
      abs(logFC.genotype.cerebrum) >= 1 & sign(logFC.genotype.cerebrum) < 0 ~ '4upup',
      abs(logFC.genotype.cerebrum) < 1 & sign(logFC.genotype.cerebrum) < 0 ~ '3up',
      abs(logFC.genotype.cerebrum) < 1 & sign(logFC.genotype.cerebrum) > 0 ~ '2down',
      abs(logFC.genotype.cerebrum) >= 1 & sign(logFC.genotype.cerebrum) > 0 ~ '1downdown',
    ),
    logFC.genotype.cerebellum = case_when(
      abs(logFC.genotype.cerebellum) >= 1 & sign(logFC.genotype.cerebellum) < 0 ~ '4upup',
      abs(logFC.genotype.cerebellum) < 1 & sign(logFC.genotype.cerebellum) < 0 ~ '3up',
      abs(logFC.genotype.cerebellum) < 1 & sign(logFC.genotype.cerebellum) > 0 ~ '2down',
      abs(logFC.genotype.cerebellum) >= 1 & sign(logFC.genotype.cerebellum) > 0 ~ '1downdown',
    ),
  ) %>%
  arrange(
    logFC.genotype.cerebrum,
    desc(logFC.genotype.cerebellum)
  ) %>%
  filter(!is.na(gene_name))

.x <-
  plot_data %>%
  select(starts_with('logFC')) %>%
  as.matrix()
rownames(.x) <- plot_data$gene_name
.gap <- unit(0.3, 'mm')

path <- paste0('results/complex-heatmap/genotype-edger-merged.svg')
svg(path, width = 5, height = 10)
h_merged <- Heatmap(
  .x,
  column_title = paste('genotype effect in both tissues, FDR <', format(fdr_th, scientific = FALSE)),
  cluster_columns = FALSE,
  cluster_rows = FALSE,
  column_split = 1:2,
  row_gap = .gap,
  column_gap = .gap,
  row_split = 1:dim(.x)[1],
  col = c('4upup' = '#D55F4FFF', '3up' = '#F9C8AFFF', '2down' = '#BBDAE9FF', '1downdown' = '#3883BAFF'),
  row_names_side = 'left',
  show_row_names = TRUE,
  width = unit(3, 'cm'),
)
draw(h_merged)
dev.off()
```
